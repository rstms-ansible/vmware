
- name: Set install_package_path
  set_fact:
    install_package_path: "{{ vm_os | lower }}/install"

- name: set install_package_dir
  set_fact:
    install_package_dir: "{{ install_config_dir }}/{{ install_package_path }}"

- name: Set install_package_filename
  set_fact:
    install_package_filename: "{{ instance_info.mac }}-{{ vm_hostname }}.tgz"

- name: Add openssh-server to install_packages
  set_fact:
    install_packages: "{{ install_packages | combine({ 'debian': (install_packages.debian + ['openssh-server']) }) }}"
  when: vm_sshd_enabled

- name: Verify disk encryption passphrase
  assert:
    that:
      - vm_fde_passphrase is defined
      - vm_fde_password | length > vm_fde_passphrase_minimum_length
    fail_msg: "vm_fde_passphrase must be provided as a vaulted variable"
  when: vm_fde_enabled and (vm_fde_mode == 'p')

- name: Hash user password 
  command:
    cmd: openssl passwd -6 -stdin
    stdin: "{{ vm_password }}"
  register: user_password_hash
  delegate_to: localhost
  become: false

- name: Generate root password
  include_tasks: generate_password.yml
  vars:
    label: "{{ vm_hostname }}_root"
    length: "{{ vm_password_length }}"
    vault_file: "{{ vm_secrets_file }}"

- name: Hash root password
  command: 
    cmd: openssl passwd -6 -stdin
    stdin: "{{ generated_password.stdout | trim }}"
  register: root_password_hash
  delegate_to: localhost
  become: false

- name: Generate FDE password
  include_tasks: generate_password.yml
  vars:
    label: "{{ vm_hostname }}_disk"
    length: "{{ vm_fde_password_length }}"
    vault_file: "{{ vm_secrets_file }}"
  when: vm_fde_enabled

- name: Upload autoinstall config file
  template:
    src: debian_preseed.j2
    dest: "{{ install_config_dir }}/{{ instance_info.mac }}-preseed.conf"
    owner: root
    group: www
    mode: '0644'
    force: true

- name: Rewrite config index
  shell:
    cmd: "ls -lT >index.txt"
    chdir: "{{ install_config_dir }}"

- name: Create and upload site_package tarball
  include_tasks: "upload_site_package.yml"

- name: Reload httpd
  command: rcctl reload httpd
